<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Electronics Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --panel: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* Sidebar Controls */
        .sidebar {
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        h2, h3 { margin-top: 0; color: var(--primary); }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9em; font-weight: 600; margin-bottom: 5px; }
        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        button {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover { opacity: 0.9; }

        /* Main Content */
        .main {
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            overflow-y: auto;
        }

        /* Circuit Diagram Placeholder */
        .diagram-box {
            background: #e2e8f0;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #64748b;
            position: relative;
        }
        .diagram-box img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        /* Metrics Grid */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .metric-card {
            background: var(--panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .metric-val { font-size: 1.2em; font-weight: bold; color: var(--primary); }
        .metric-label { font-size: 0.8em; color: #64748b; }

        /* Charts */
        .charts-container {
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        canvas { max-height: 400px; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Configuration</h2>
        
        <div class="control-group">
            <label>Phase Configuration</label>
            <select id="phase">
                <option value="1">Single Phase</option>
                <option value="3">Three Phase</option>
            </select>
        </div>

        <div class="control-group">
            <label>Rectifier Type</label>
            <select id="rectType">
                <option value="half">Half Wave</option>
                <option value="full">Full Wave (Bridge)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Load Type</label>
            <select id="loadType" onchange="toggleInputs()">
                <option value="R">Resistive (R)</option>
                <option value="RL">Inductive (RL)</option>
                <option value="RC">Capacitive (RC)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Freewheeling Diode (FWD)</label>
            <select id="fwd">
                <option value="no">Without FWD</option>
                <option value="yes">With FWD</option>
            </select>
        </div>

        <hr>

        <div class="control-group">
            <label>Input Voltage Type</label>
            <select id="vType">
                <option value="rms">RMS</option>
                <option value="max">Peak (Max)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Voltage Magnitude (Volts)</label>
            <input type="number" id="vin_val" value="220">
        </div>

        <div class="control-group">
            <label>Frequency (Hz)</label>
            <input type="number" id="freq" value="50">
        </div>

        <hr>

        <div class="control-group" id="input-R">
            <label>Resistance R (Ω)</label>
            <input type="number" id="r_val" value="10">
        </div>

        <div class="control-group" id="input-L" style="display:none;">
            <label>Inductance L (H)</label>
            <input type="number" id="l_val" value="0.1" step="0.001">
        </div>

        <div class="control-group" id="input-C" style="display:none;">
            <label>Capacitance C (µF)</label>
            <input type="number" id="c_val" value="1000">
        </div>

        <button onclick="runSimulation()">SIMULATE</button>
    </div>

    <div class="main">
        
        <div class="diagram-box" id="diagramContainer">
            <h3 style="color: #64748b;">CIRCUIT DIAGRAM</h3>
            <p>Right click here "Inspect" to edit HTML and insert your image source.</p>
            <small id="circuitLabel">Configuration: 1-Phase Half Wave R-Load</small>
        </div>

        <div class="metrics">
            <div class="metric-card"><div class="metric-val" id="out_Vrms">-</div><div class="metric-label">V (RMS)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Vdc">-</div><div class="metric-label">V (DC/Avg)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Irms">-</div><div class="metric-label">I (RMS)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Idc">-</div><div class="metric-label">I (DC/Avg)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Pdc">-</div><div class="metric-label">Power (DC)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Pac">-</div><div class="metric-label">Power (AC Active)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_fo">-</div><div class="metric-label">Freq Out</div></div>
            <div class="metric-card"><div class="metric-val" id="out_Vac">-</div><div class="metric-label">V (Ripple AC)</div></div>
            <div class="metric-card"><div class="metric-val" id="out_FF">-</div><div class="metric-label">Form Factor</div></div>
            <div class="metric-card"><div class="metric-val" id="out_RF">-</div><div class="metric-label">Ripple Factor</div></div>
            <div class="metric-card"><div class="metric-val" id="out_EF">-</div><div class="metric-label">Efficiency %</div></div>
        </div>

        <div class="charts-container">
            <canvas id="mainChart"></canvas>
        </div>

    </div>

    <script>
        let myChart = null;

        // Toggle L and C inputs based on Load Selection
        function toggleInputs() {
            const type = document.getElementById('loadType').value;
            document.getElementById('input-L').style.display = (type === 'RL') ? 'block' : 'none';
            document.getElementById('input-C').style.display = (type === 'RC') ? 'block' : 'none';
        }

        function runSimulation() {
            // 1. Gather Inputs
            const phase = parseInt(document.getElementById('phase').value);
            const rectType = document.getElementById('rectType').value; // 'half' or 'full'
            const loadType = document.getElementById('loadType').value;
            const useFWD = document.getElementById('fwd').value === 'yes';
            
            let vInVal = parseFloat(document.getElementById('vin_val').value);
            const vType = document.getElementById('vType').value;
            const freq = parseFloat(document.getElementById('freq').value);
            const R = parseFloat(document.getElementById('r_val').value);
            const L = (loadType === 'RL') ? parseFloat(document.getElementById('l_val').value) : 0;
            const C = (loadType === 'RC') ? parseFloat(document.getElementById('c_val').value) * 1e-6 : 0;

            // Convert to Vpeak
            let Vm = (vType === 'rms') ? vInVal * Math.sqrt(2) : vInVal;
            
            // 2. Simulation Parameters
            const cycles = 3;
            const period = 1 / freq;
            const samplesPerCycle = 360; 
            const totalSamples = samplesPerCycle * cycles;
            const dt = period / samplesPerCycle;
            const omega = 2 * Math.PI * freq;

            // Arrays for plotting
            let timeArr = [];
            let vInArr = [];
            let vOutArr = [];
            let iOutArr = [];

            // State variables for Numerical Integration (Euler method)
            let i_curr = 0; 
            let v_cap = 0; // Initial capacitor voltage

            // 3. Update Circuit Label
            document.getElementById('circuitLabel').innerText = 
                `${phase}-Phase ${rectType}-Wave ${loadType}-Load ${useFWD ? '(With FWD)' : ''}`;

            // 4. Simulation Loop
            for (let n = 0; n < totalSamples; n++) {
                let t = n * dt;
                let theta = omega * t;

                // --- A. Generate Input Voltages ---
                let Va = Vm * Math.sin(theta);
                let Vb = Vm * Math.sin(theta - (2*Math.PI/3));
                let Vc = Vm * Math.sin(theta + (2*Math.PI/3));
                
                let v_supply_instant = 0;

                // --- B. Determine Rectified Voltage (Unloaded) ---
                // This is the voltage trying to drive the load *before* L/C effects
                if (phase === 1) {
                    if (rectType === 'half') {
                        v_supply_instant = (Va > 0) ? Va : 0;
                    } else {
                        v_supply_instant = Math.abs(Va);
                    }
                } else { // 3 Phase
                    if (rectType === 'half') {
                        // 3-ph Half Wave: Max of Phase Voltages
                        v_supply_instant = Math.max(Va, Vb, Vc);
                        if(v_supply_instant < 0) v_supply_instant = 0; // Usually specific to neutral
                    } else {
                        // 3-ph Full Wave: Max Line-to-Line -> (Max Phase - Min Phase)
                        let maxV = Math.max(Va, Vb, Vc);
                        let minV = Math.min(Va, Vb, Vc);
                        v_supply_instant = maxV - minV;
                    }
                }

                // --- C. Apply Load Physics (R, RL, RC) ---
                let v_load = 0;
                let i_load = 0;

                if (loadType === 'R') {
                    v_load = v_supply_instant;
                    i_load = v_load / R;
                } 
                else if (loadType === 'RL') {
                    // Differential Equation: L(di/dt) + Ri = V_applied
                    // V_applied logic with FWD:
                    // If Source > 0, Source drives load.
                    // If Source <= 0, FWD clamps load V to 0 (current circulates), else Open (current dies).
                    
                    let driving_V = v_supply_instant;
                    
                    // Specific logic for 1-Phase Half Wave RL without FWD (negative excursion allowed in some texts, 
                    // but standard rectifier simulation usually implies diode blocks negative V_source unless current keeps it on)
                    // For simulation simplicity: The diode conducts if Anode > Cathode OR Current > 0
                    
                    // Logic: Calculate potential new current assuming diode is ON
                    // di = (V_source - R*i_old) * dt / L
                    // If rectType is Half Wave and V_source goes negative:
                    //   Without FWD: Source is physically connected, so V_load can be negative IF current is flowing.
                    //   With FWD: V_load clamps to 0.
                    
                    let v_forcing = 0;

                    // Complex Commutation Logic Simplification:
                    // 1. Is the diode forward biased by voltage? OR Is there established current?
                    let source_voltage_raw = (phase === 1 && rectType === 'half') ? Va : v_supply_instant;
                    
                    // For Bridge, source is always positive |sin|. For HW, it can be sin.
                    
                    if (phase === 1 && rectType === 'half') {
                         if (useFWD) {
                            // FWD Logic: If Source < 0, V_forcing = 0. If Source > 0, V_forcing = Source.
                            v_forcing = (Va > 0) ? Va : 0;
                         } else {
                            // No FWD: V_forcing follows Source (even negative) as long as I > 0
                            v_forcing = Va;
                         }
                    } else {
                        // Full wave or 3-Phase usually produce positive ripple. 
                        // FWD rarely needed for Full Bridge as diodes naturally freewheel, 
                        // but if specified, it ensures V never dips below 0 (redundant for bridge).
                        v_forcing = v_supply_instant;
                    }

                    // Euler Step
                    let di = (v_forcing - R * i_curr) * (dt / L);
                    let i_next = i_curr + di;

                    if (i_next < 0) i_next = 0; // Diode blocking
                    
                    // Determine actual V_load based on conduction
                    if (i_next > 0) {
                        v_load = v_forcing; 
                    } else {
                        v_load = (phase === 1 && rectType === 'half') ? Va : v_supply_instant; 
                        // If no current, we see the open circuit voltage or 0 depending on where we probe.
                        // Standard scope probe across load:
                        v_load = (v_forcing > 0) ? v_forcing : 0; 
                    }

                    i_curr = i_next;
                    i_load = i_curr;
                } 
                else if (loadType === 'RC') {
                    // Capacitor Filter logic
                    // If V_supply > V_cap, Diode ON, Charge Cap.
                    // If V_supply < V_cap, Diode OFF, Discharge Cap.
                    
                    if (v_supply_instant > v_cap) {
                        // Charging (Ideal Diode Model: V_cap follows V_supply)
                        // In reality, there is small resistance, but ideal rectifier assumes V_load = V_supply
                        v_cap = v_supply_instant;
                    } else {
                        // Discharging: V_new = V_old * e^(-dt/RC)
                        v_cap = v_cap * Math.exp(-dt / (R * C));
                    }
                    v_load = v_cap;
                    i_load = v_load / R; // Current through Resistor
                    // Note: Source current would include Id = C dv/dt + V/R, but usually we plot Load Current
                }

                // Store Data (Skip first cycle to let transients settle for better RMS calc)
                if (n > samplesPerCycle) {
                    timeArr.push(t.toFixed(4));
                    vInArr.push(Va); // Plot Phase A as reference
                    vOutArr.push(v_load);
                    iOutArr.push(i_load);
                }
            }

            // 5. Calculations (on steady state data)
            let sumV = 0, sumV2 = 0;
            let sumI = 0, sumI2 = 0;
            let sumP = 0; // Instantaneous Power Sum
            const N = vOutArr.length;
            
            // Peak detection for Ripple
            let maxVout = -Infinity, minVout = Infinity;

            for(let k=0; k<N; k++) {
                let v = vOutArr[k];
                let i = iOutArr[k];
                sumV += v;
                sumV2 += (v*v);
                sumI += i;
                sumI2 += (i*i);
                sumP += (v*i); // Active Power

                if(v > maxVout) maxVout = v;
                if(v < minVout) minVout = v;
            }

            const Vdc = sumV / N;
            const Vrms = Math.sqrt(sumV2 / N);
            const Idc = sumI / N;
            const Irms = Math.sqrt(sumI2 / N);
            
            // Power
            const Pdc = Vdc * Idc;
            const Pac_active = sumP / N; // Average of instantaneous power

            // Factors
            // Ripple Voltage (AC component of output)
            // Vac_rms = sqrt(Vrms^2 - Vdc^2)
            const Vac_ripple = Math.sqrt(Math.max(0, Vrms*Vrms - Vdc*Vdc));
            
            const FF = (Vdc !== 0) ? (Vrms / Vdc) : 0;
            const RF = (Vdc !== 0) ? (Vac_ripple / Vdc) : 0;
            
            // Efficiency (Rectification Efficiency = Pdc / P_in)
            // Estimation: P_in is approx Pac_active for ideal diodes
            const EF = (Pac_active !== 0) ? (Pdc / Pac_active) * 100 : 0;

            // Output Frequency
            let pulseCount = 0;
            if(phase === 1 && rectType === 'half') pulseCount = 1;
            else if(phase === 1 && rectType === 'full') pulseCount = 2;
            else if(phase === 3 && rectType === 'half') pulseCount = 3;
            else if(phase === 3 && rectType === 'full') pulseCount = 6;
            const fOut = freq * pulseCount;

            // 6. Update UI
            document.getElementById('out_Vrms').innerText = Vrms.toFixed(2);
            document.getElementById('out_Vdc').innerText = Vdc.toFixed(2);
            document.getElementById('out_Irms').innerText = Irms.toFixed(2);
            document.getElementById('out_Idc').innerText = Idc.toFixed(2);
            document.getElementById('out_Pdc').innerText = Pdc.toFixed(2) + " W";
            document.getElementById('out_Pac').innerText = Pac_active.toFixed(2) + " W";
            document.getElementById('out_fo').innerText = fOut + " Hz";
            document.getElementById('out_Vac').innerText = Vac_ripple.toFixed(2);
            document.getElementById('out_FF').innerText = FF.toFixed(3);
            document.getElementById('out_RF').innerText = RF.toFixed(3);
            document.getElementById('out_EF').innerText = EF.toFixed(1) + "%";

            // 7. Render Graph
            renderChart(timeArr, vInArr, vOutArr, iOutArr);
        }

        function renderChart(labels, vIn, vOut, iOut) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Input Voltage (Phase A)',
                            data: vIn,
                            borderColor: '#94a3b8', // Gray
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [5, 5],
                            yAxisID: 'y'
                        },
                        {
                            label: 'Output Voltage',
                            data: vOut,
                            borderColor: '#2563eb', // Blue
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Output Current',
                            data: iOut,
                            borderColor: '#dc2626', // Red
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Time (s)' },
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Voltage (V)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Current (A)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Initialize on load
        toggleInputs();
        runSimulation();
    </script>
</body>
</html>
