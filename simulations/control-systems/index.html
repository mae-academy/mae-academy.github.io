<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAE Academy — Control Systems</title>

  <link rel="icon" type="image/svg+xml" href="../../favicon-16.svg">

  <!-- Chart.js (like Code #1) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#eaf2ff;
      --bg2:#f8fbff;
      --card:#ffffff;
      --text:#09102a;
      --muted:#4c5d88;
      --brand:#08b58d;
      --brand2:#3f6fff;
      --danger:#d32f2f;
      --border: rgba(9,16,42,.14);
      --shadow: 0 22px 60px rgba(16,24,40,.12);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Apple Gothic",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      transition: opacity 0.5s ease;
      opacity: 0;
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(63,111,255,.20), transparent 55%),
        radial-gradient(900px 520px at 86% 0%, rgba(8,181,141,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .container{width:min(1200px,92%);margin-inline:auto}

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(234,242,255,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 0;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logoMark{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 220deg, var(--brand), var(--brand2), var(--brand));
      position:relative;
      box-shadow: 0 14px 30px rgba(63,111,255,.18);
      overflow:hidden;
      display:grid;
      place-items:center;
    }

    .logoSvg{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: brightness(0) invert(1); /* makes svg white */
      position:relative;
      z-index:2; /* فوق shimmer */
    }
    .logoMark::after{
      content:""; position:absolute; inset:-60%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.75), transparent 55%);
      animation: shimmer 5.6s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%,100%{transform:translate(12%,12%) rotate(0deg)}
      50%{transform:translate(-12%,-12%) rotate(25deg)}
    }
    .brand h1{margin:0;font-size:15px;line-height:1.2}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      transition: transform .2s ease, box-shadow .2s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: var(--shadow)}
    .btn.primary{
      border: none;
      background: linear-gradient(135deg, rgba(8,181,141,.95), rgba(63,111,255,.90));
      color:#06101a;
    }

    main{padding: 44px 0 70px}

    .headRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom: 16px;
    }
    .titleWrap{display:flex; align-items:center; gap:12px}
    .simIcon{
      width:46px;height:46px;border-radius:16px;
      border:1px solid rgba(9,16,42,.12);
      background: rgba(255,255,255,.72);
      display:grid; place-items:center;
      box-shadow: 0 10px 20px rgba(16,24,40,.08);
      overflow:hidden;
    }
    .simIcon img{width:32px;height:32px;object-fit:contain}
    h2{
      margin:0;
      font-size: 44px;
      letter-spacing:-1px;
      line-height:1.05;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      font-weight: 650;
      line-height:1.8;
      max-width: 72ch;
    }

    .simContainer{
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(9,16,42,.12);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: 0 12px 30px rgba(16,24,40,.08);
      padding: 16px;
      position:relative;
      overflow:hidden;
    }
    .simContainer::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 220px at 70% 10%, rgba(8,181,141,.14), transparent 60%),
        radial-gradient(520px 240px at 20% 70%, rgba(63,111,255,.14), transparent 60%);
      opacity:.8;
      z-index:0;
    }
    .simContainer > *{position:relative; z-index:1}

    .visualsRow{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    @media (max-width: 980px){
      .visualsRow{grid-template-columns:1fr}
    }

    .panel{
      border: 1px solid rgba(9,16,42,.12);
      border-radius: var(--radius);
      background: rgba(255,255,255,.85);
      padding: 12px;
      box-shadow: 0 10px 20px rgba(16,24,40,.06);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position:relative;
      overflow:hidden;
    }
    .panel:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: rgba(63,111,255,.22);
    }
    .panelLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 900;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .panelLabel .small{
      font-weight: 800;
      font-size: 12px;
      color: var(--muted);
    }

    /* Chart canvases */
    .chartWrap{
      position:relative;
      height:360px; /* IMPORTANT for responsive Chart.js */
      width:100%;
    }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(9,16,42,.10);
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .warningOverlay{
      position:absolute;
      inset: 12px;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(9,16,42,.12);
      border-radius: var(--radius);
      color: var(--danger);
      font-weight: 900;
      z-index:10;
      animation: shake 450ms ease both;
      text-align:center;
      backdrop-filter: blur(8px);
    }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
    }

    .controlsArea{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      background: rgba(255,255,255,.68);
      border: 1px solid rgba(9,16,42,.12);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 10px 20px rgba(16,24,40,.06);
    }
    @media (max-width: 980px){
      .controlsArea{grid-template-columns:1fr}
    }

    .col{display:flex; flex-direction:column; gap:12px}
    .colHead{
      font-weight: 1000;
      font-size: 13px;
      letter-spacing: .8px;
      text-transform:uppercase;
      color: rgba(9,16,42,.88);
      border-bottom: 2px solid rgba(9,16,42,.14);
      padding-bottom: 8px;
    }

    .group label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 6px;
      color: rgba(9,16,42,.92);
    }
    input[type="range"]{width:100%; cursor:pointer}

    select{
      width:100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(9,16,42,.16);
      font-weight: 900;
      cursor:pointer;
      background: rgba(255,255,255,.9);
      transition: box-shadow .12s ease;
      font-family:"Inter",system-ui,sans-serif;
    }
    select:focus{outline:none; box-shadow: 0 0 0 6px rgba(63,111,255,.12)}

    .modeToggle{
      display:flex;
      background: rgba(9,16,42,.06);
      border-radius: 16px;
      padding: 4px;
      gap: 4px;
      border: 1px solid rgba(9,16,42,.10);
    }
    .modeBtn{
      flex:1;
      border:none;
      border-radius: 14px;
      padding: 10px;
      font-weight: 1000;
      cursor:pointer;
      background: transparent;
      color: rgba(9,16,42,.55);
      transition: background .15s ease, transform .12s ease, box-shadow .15s ease;
      font-family:"Inter",system-ui,sans-serif;
    }
    .modeBtn.active{
      background: rgba(255,255,255,.9);
      color: rgba(9,16,42,.95);
      box-shadow: 0 10px 18px rgba(16,24,40,.10);
      border: 1px solid rgba(9,16,42,.12);
    }
    .modeBtn:active{transform:scale(0.98)}

    .primaryBtn{
      width:100%;
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      background: linear-gradient(135deg, rgba(8,181,141,.95), rgba(63,111,255,.90));
      color:#06101a;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .2s ease;
      font-family:"Inter",system-ui,sans-serif;
    }
    .primaryBtn:hover{transform: translateY(-2px); box-shadow: var(--shadow)}
    .primaryBtn:active{transform: translateY(0px)}

    .math{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 900;
      font-size: 12px;
      color: rgba(9,16,42,.88);
      background: rgba(255,255,255,.8);
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(9,16,42,.10);
      min-height: 24px;
      word-wrap:break-word;
    }

    .badgeStatus{
      margin-top: 8px;
      width:100%;
      text-align:center;
      padding: 10px 12px;
      border-radius: 16px;
      font-weight: 1000;
      font-size: 14px;
      transition: transform .18s ease;
      border: 1px solid rgba(9,16,42,.10);
      background: rgba(255,255,255,.85);
    }
    .stable{color:#155724; background: rgba(212,237,218,.85)}
    .unstable{color:#721c24; background: rgba(248,215,218,.85)}
    .bump{transform: scale(1.03)}

    .note{
      font-size:12px;
      font-weight: 900;
      color: rgba(9,16,42,.82);
      background: rgba(63,111,255,.10);
      padding: 10px;
      border-radius: 16px;
      line-height: 1.35;
      border: 1px solid rgba(63,111,255,.18);
    }

    .reveal{
      opacity:0;
      transform: translateY(14px) scale(.99);
      transition: opacity .7s ease, transform .7s ease;
    }
    .reveal.isVisible{
      opacity:1;
      transform: translateY(0) scale(1);
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
      .reveal{opacity:1; transform:none}
    }
  </style>
</head>

<body>
  <header>
    <div class="container nav">
      <a class="brand" href="../../" aria-label="Home">
        <div class="logoMark" aria-hidden="true">
          <img class="logoSvg" src="../../assets/mae.svg" alt="">
        </div>
        <div>
          <h1>MAE Academy</h1>
          <p>Control Systems Simulator</p>
        </div>
      </a>

      <div class="actions">
        <a class="btn" href="../">Back to Simulations</a>
        <a class="btn primary" href="../../#contact">Start ↗</a>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="headRow reveal">
        <div>
          <div class="titleWrap">
            
            <div>
              <h2>Control Systems</h2>
              <div class="sub">Time response • Root locus • PID tuning</div>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" type="button" onclick="triggerStep()">Trigger Step</button>
          <button class="btn primary" type="button" onclick="resetSim()">Reset</button>
        </div>
      </div>

      <div class="simContainer reveal">
        <div class="visualsRow">
          <div class="panel">
            <div class="panelLabel">
              <span>Time Response</span>
              
            </div>

            <div style="position:relative">
              <div class="chartWrap">
                <canvas id="simCanvas"></canvas>
              </div>

              <div id="sim-warning" class="warningOverlay">
                <div style="font-size:40px; margin-bottom:8px;">⚠️</div>
                <div style="font-size:20px;">Unstable!</div>
                <div style="font-size:13px; font-weight:900; margin-top:6px; color:#a11f1f;">System reset.</div>
              </div>
            </div>

            <div class="hint">Use the SP slider below to set the setpoint.</div>
          </div>

          <div class="panel">
            <div class="panelLabel">
              <span>Root Locus (Poles)</span>
              <span class="small">Closed-loop poles</span>
            </div>

            <div class="chartWrap">
              <canvas id="sPlaneCanvas"></canvas>
            </div>

            <div class="hint">Poles are marked as red ✕ on the s-plane.</div>
          </div>
        </div>

        <div class="controlsArea">
          <!-- 1) Plant -->
          <div class="col">
            <div class="colHead">1. System Plant</div>

            <div class="group">
              <label>System Order</label>
              <select id="sys-order" onchange="updateUI()">
                <option value="1">1st Order (Thermal)</option>
                <option value="2" selected>2nd Order (Spring-Mass)</option>
                <option value="3">3rd Order (Motor + Inductance)</option>
              </select>
            </div>

            <div class="group param-1st" style="display:none;">
              <label>Time Constant (τ): <span id="val-tau">1.0</span>s</label>
              <input type="range" id="inp-tau" min="0.5" max="5.0" step="0.1" value="1.0">
            </div>

            <div class="group param-2nd">
              <label>Natural Freq (ωn): <span id="val-wn">5.0</span></label>
              <input type="range" id="inp-wn" min="1" max="15" step="0.5" value="5.0">
            </div>

            <div class="group param-2nd">
              <label>Damping Ratio (ζ): <span id="val-zeta">0.5</span></label>
              <input type="range" id="inp-zeta" min="0" max="2.0" step="0.05" value="0.5">
            </div>

            <div class="group">
              <label>Setpoint (SP): <span id="val-sp">50</span></label>
              <input type="range" id="inp-sp" min="0" max="125" step="1" value="50">
            </div>

            <div class="group param-3rd" style="display:none;">
              <label>Lag Pole (p): <span id="val-p3">10.0</span></label>
              <input type="range" id="inp-p3" min="1" max="20" step="1" value="10.0">
              <div class="hint">Adds pole at s = −p</div>
            </div>
          </div>

          <!-- 2) Controller -->
          <div class="col">
            <div class="colHead">2. Controller</div>

            <div class="modeToggle">
              <button class="modeBtn active" id="mode-manual" type="button" onclick="setMode('manual')">Manual (PID)</button>
              <button class="modeBtn" id="mode-design" type="button" onclick="setMode('design')">Design (ζ, ω)</button>
            </div>

            <div id="ctrl-manual">
              <div class="group">
                <label>Kp: <span id="val-kp">5.0</span></label>
                <input type="range" id="inp-kp" min="0" max="100" step="0.5" value="5.0">
              </div>

              <div class="group">
                <label>Ki: <span id="val-ki">1.0</span></label>
                <input type="range" id="inp-ki" min="0" max="50" step="0.5" value="1.0">
              </div>

              <div class="group">
                <label>Kd: <span id="val-kd">2.0</span></label>
                <input type="range" id="inp-kd" min="0" max="50" step="0.1" value="2.0">
              </div>
            </div>

            <div id="ctrl-design" style="display:none;">
              <div class="note">Auto-calculates PID for target response (2nd order only)</div>

              <div class="group" style="margin-top:10px;">
                <label>Target ωn: <span id="val-twn">6.0</span></label>
                <input type="range" id="inp-twn" min="1" max="20" step="0.5" value="6.0">
              </div>

              <div class="group">
                <label>Target ζ: <span id="val-tzeta">0.7</span></label>
                <input type="range" id="inp-tzeta" min="0.1" max="1.5" step="0.05" value="0.7">
              </div>

              <div class="note" style="background: rgba(8,181,141,.12); border-color: rgba(8,181,141,.18);">
                Result: Kp=<span id="res-kp">--</span> &nbsp; Kd=<span id="res-kd">--</span>
              </div>
            </div>

            <button class="primaryBtn" type="button" onclick="triggerStep()">Trigger Step</button>
          </div>

          <!-- 3) Analysis -->
          <div class="col">
            <div class="colHead">3. Analysis</div>

            <div style="font-size:12px; font-weight:900; color: rgba(9,16,42,.60);">Characteristic Equation:</div>
            <div id="math-char-eq" class="math">...</div>

            <div style="font-size:12px; font-weight:900; color: rgba(9,16,42,.60); margin-top:10px;">Closed-Loop Poles:</div>
            <div id="math-roots" class="math">...</div>

            <div id="status-badge" class="badgeStatus stable">Stable</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Page transition
    window.addEventListener('load', () => {
      document.body.style.opacity = '1';
    });
    document.addEventListener('click', e => {
      const link = e.target.closest('a');
      if (link && link.href && !link.href.startsWith('javascript') && !link.target) {
        e.preventDefault();
        document.body.style.opacity = '0';
        setTimeout(() => {
          window.location = link.href;
        }, 250);
      }
    });

    // =========================
    // Core Globals
    // =========================
    let simChart = null;
    let sPlaneChart = null;

    let sys = { order: 2, tau: 1.0, wn: 5.0, zeta: 0.5, p3: 10.0 };
    let pid = { sp: 50, kp: 5.0, ki: 1.0, kd: 2.0 };
    let design = { wn: 6.0, zeta: 0.7 };

    let state = { pv: 0, vel: 0, acc: 0, integ: 0, lastErr: 0 };

    const MAX_HISTORY = 600;
    const DT_FRAME = 0.02;

    // store time-series like Code #1
    let tSeries = [];
    let spSeries = [];
    let pvSeries = [];
    let simTime = 0;

    let controlMode = 'manual';
    let lastStable = true;

    // Chart update throttling
    let lastChartUpdate = 0;
    const CHART_UPDATE_MS = 80; // smooth + efficient

    init();

    function init() {
      // wheel on Time chart = adjust SP
      // Removed: SP now controlled by slider

      bindInputs();
      makeCharts();
      updateUI();

      // Reveal
      const revealEls = document.querySelectorAll(".reveal");
      const io = new IntersectionObserver((entries) => {
        for(const e of entries){
          if(e.isIntersecting){
            e.target.classList.add("isVisible");
            io.unobserve(e.target);
          }
        }
      }, {threshold: 0.12});
      revealEls.forEach(el => io.observe(el));

      requestAnimationFrame(loop);
    }

    // =========================
    // Chart.js setup (like Code #1)
    // =========================
    function makeCharts() {
      // 1) Time response chart
      const simCtx = document.getElementById('simCanvas').getContext('2d');
      simChart = new Chart(simCtx, {
        type: 'line',
        data: {
          labels: tSeries, // time in seconds
          datasets: [
            {
              label: 'Setpoint (SP)',
              data: spSeries,
              borderWidth: 2,
              pointRadius: 0,
              borderDash: [6, 6],
              tension: 0.05,
              borderColor: '#08b58d'
            },
            {
              label: 'Process Variable (PV)',
              data: pvSeries,
              borderWidth: 3,
              pointRadius: 0,
              tension: 0.1,
              borderColor: '#3f6fff'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true },
            tooltip: { enabled: true }
          },
          scales: {
            x: {
              title: { display: true, text: 'Time (s)' },
              ticks: { maxTicksLimit: 10 }
            },
            y: {
              title: { display: true, text: 'Value' },
              suggestedMin: -20,
              suggestedMax: 140
            }
          }
        }
      });

      // 2) S-plane scatter chart
      const sCtx = document.getElementById('sPlaneCanvas').getContext('2d');
      sPlaneChart = new Chart(sCtx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Poles',
              data: [],
              pointRadius: 6,
              pointHoverRadius: 7
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const x = ctx.raw.x ?? 0;
                  const y = ctx.raw.y ?? 0;
                  return `s = ${x.toFixed(2)} ${y >= 0 ? '+' : '-'} j${Math.abs(y).toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Re(s)' },
              grid: { drawBorder: true },
              suggestedMin: -20,
              suggestedMax: 10
            },
            y: {
              title: { display: true, text: 'Im(s)' },
              suggestedMin: -15,
              suggestedMax: 15
            }
          }
        }
      });
    }

    function pushHistory(sp, pv) {
      simTime += DT_FRAME;

      tSeries.push(simTime.toFixed(2));
      spSeries.push(sp);
      pvSeries.push(pv);

      if (tSeries.length > MAX_HISTORY) {
        tSeries.shift();
        spSeries.shift();
        pvSeries.shift();
      }
    }

    function updateChartsMaybe() {
      const now = performance.now();
      if (now - lastChartUpdate < CHART_UPDATE_MS) return;
      lastChartUpdate = now;

      // update time chart
      simChart.update('none');
    }

    function updateSPlaneChart(roots) {
      // map roots -> scatter points (x=re, y=im)
      const pts = roots.map(r => ({ x: r.re, y: r.im }));

      // make points look like red "X" visually: use rotated square (close enough) via pointStyle
      sPlaneChart.data.datasets[0].data = pts;
      sPlaneChart.data.datasets[0].pointStyle = 'crossRot';
      sPlaneChart.data.datasets[0].borderColor = '#d32f2f';
      sPlaneChart.data.datasets[0].backgroundColor = '#d32f2f';

      // auto-range a bit
      const reVals = pts.map(p => p.x);
      const imVals = pts.map(p => p.y);
      if (reVals.length) {
        const minX = Math.min(...reVals) - 2;
        const maxX = Math.max(...reVals) + 2;
        const maxAbsY = Math.max(2, ...imVals.map(v => Math.abs(v))) + 2;

        sPlaneChart.options.scales.x.suggestedMin = Math.min(-20, minX);
        sPlaneChart.options.scales.x.suggestedMax = Math.max(10, maxX);
        sPlaneChart.options.scales.y.suggestedMin = -maxAbsY;
        sPlaneChart.options.scales.y.suggestedMax = maxAbsY;
      }

      sPlaneChart.update('none');
    }

    // =========================
    // UI Logic
    // =========================
    function setMode(mode) {
      controlMode = mode;

      document.getElementById('mode-manual').className = mode === 'manual' ? 'modeBtn active' : 'modeBtn';
      document.getElementById('mode-design').className = mode === 'design' ? 'modeBtn active' : 'modeBtn';

      document.getElementById('ctrl-manual').style.display = mode === 'manual' ? 'block' : 'none';
      document.getElementById('ctrl-design').style.display = mode === 'design' ? 'block' : 'none';

      if (mode === 'design') runAutoTune();
      analyze();
    }

    function bindInputs() {
      const bind = (id, obj, key) => {
        const el = document.getElementById(id);
        el.addEventListener('input', e => {
          obj[key] = parseFloat(e.target.value);
          const valEl = document.getElementById(id.replace('inp', 'val'));
          if(valEl) valEl.innerText = obj[key];
          if (controlMode === 'design') runAutoTune();
          analyze();
        });
      };

      bind('inp-tau', sys, 'tau');
      bind('inp-wn', sys, 'wn');
      bind('inp-zeta', sys, 'zeta');
      bind('inp-p3', sys, 'p3');

      bind('inp-sp', pid, 'sp');
      bind('inp-kp', pid, 'kp');
      bind('inp-ki', pid, 'ki');
      bind('inp-kd', pid, 'kd');

      bind('inp-twn', design, 'wn');
      bind('inp-tzeta', design, 'zeta');
    }

    function updateUI() {
      sys.order = parseInt(document.getElementById('sys-order').value);

      document.querySelectorAll('.param-1st').forEach(e => e.style.display = sys.order === 1 ? 'block' : 'none');
      document.querySelectorAll('.param-2nd').forEach(e => e.style.display = (sys.order === 2 || sys.order === 3) ? 'block' : 'none');
      document.querySelectorAll('.param-3rd').forEach(e => e.style.display = sys.order === 3 ? 'block' : 'none');

      resetSim();

      if (controlMode === 'design') runAutoTune();
      analyze();
    }

    function runAutoTune() {
      if (sys.order === 2) {
        const ws2 = sys.wn * sys.wn;
        const target_w2 = design.wn * design.wn;
        const target_mid = 2 * design.zeta * design.wn;

        const req_Kp = (target_w2 / ws2) - 1;
        const req_Kd = (target_mid - (2 * sys.zeta * sys.wn)) / ws2;

        pid.kp = Math.max(0, req_Kp);
        pid.kd = Math.max(0, req_Kd);
        pid.ki = 0.5;

        document.getElementById('res-kp').innerText = pid.kp.toFixed(2);
        document.getElementById('res-kd').innerText = pid.kd.toFixed(2);

        document.getElementById('inp-kp').value = pid.kp;
        document.getElementById('val-kp').innerText = pid.kp.toFixed(2);

        document.getElementById('inp-kd').value = pid.kd;
        document.getElementById('val-kd').innerText = pid.kd.toFixed(2);

        document.getElementById('inp-ki').value = pid.ki;
        document.getElementById('val-ki').innerText = pid.ki.toFixed(2);
      } else {
        document.getElementById('res-kp').innerText = "N/A";
        document.getElementById('res-kd').innerText = "N/A";
      }
    }

    function resetSim() {
      state = { pv: 0, vel: 0, acc: 0, integ: 0, lastErr: 0 };

      // reset series
      tSeries.length = 0;
      spSeries.length = 0;
      pvSeries.length = 0;
      simTime = 0;

      // seed with zeros so chart is not empty
      for (let i = 0; i < 10; i++) {
        tSeries.push((i * DT_FRAME).toFixed(2));
        spSeries.push(pid.sp);
        pvSeries.push(0);
      }

      document.getElementById('sim-warning').style.display = 'none';
      simChart.update('none');
    }

    function triggerStep() {
      pid.sp = (pid.sp === 50) ? 80 : 50;
      document.getElementById('inp-sp').value = pid.sp;
      document.getElementById('val-sp').innerText = pid.sp;
    }

    // =========================
    // Physics
    // =========================
    function updatePhysics() {
      const SUB = 20;
      const DT = 0.02 / SUB;

      for (let i = 0; i < SUB; i++) {
        const err = pid.sp - state.pv;
        state.integ += err * DT;

        const u =
          (pid.kp * err) +
          (pid.ki * state.integ) +
          (pid.kd * (err - state.lastErr) / DT);

        if (isNaN(u) || Math.abs(u) > 1e6) {
          handleCrash();
          return;
        }

        if (sys.order === 1) {
          state.pv += ((u - state.pv) / sys.tau) * DT;
        } else if (sys.order === 2) {
          const w2 = sys.wn * sys.wn;
          const force = (w2 * u) - (2 * sys.zeta * sys.wn * state.vel) - (w2 * state.pv);
          state.vel += force * DT;
          state.pv += state.vel * DT;
        } else if (sys.order === 3) {
          const w2 = sys.wn * sys.wn;
          const force = (w2 * u) - (2 * sys.zeta * sys.wn * state.vel) - (w2 * state.acc);
          state.vel += force * DT;
          state.acc += state.vel * DT; // x
          const y_dot = sys.p3 * (state.acc - state.pv);
          state.pv += y_dot * DT;
        }

        state.lastErr = err;

        if (Math.abs(state.pv) > 1e4) {
          handleCrash();
          return;
        }
      }

      // push one sample per frame (like scope trace)
      pushHistory(pid.sp, state.pv);
      updateChartsMaybe();
    }

    function handleCrash() {
      document.getElementById('sim-warning').style.display = 'flex';
      setTimeout(() => resetSim(), 1500);
    }

    // =========================
    // Analysis (Roots)
    // =========================
    function analyze() {
      let roots = [];
      let eqHTML = "";

      if (sys.order === 1) {
        const A = sys.tau + pid.kd;
        const B = 1 + pid.kp;
        const C = pid.ki;
        eqHTML = `${A.toFixed(1)}s² + ${B.toFixed(1)}s + ${C.toFixed(1)} = 0`;
        roots = solveQuad(A, B, C);
      } else if (sys.order === 2) {
        const w2 = sys.wn * sys.wn;
        const B = 2 * sys.zeta * sys.wn + w2 * pid.kd;
        const C = w2 + w2 * pid.kp;
        const D = w2 * pid.ki;
        eqHTML = `s³ + ${B.toFixed(1)}s² + ${C.toFixed(1)}s + ${D.toFixed(1)} = 0`;
        roots = solveCubic(B, C, D);
      } else {
        eqHTML = "Order 4 (Analysis Approx)";
        roots = [
          { re: -sys.p3, im: 0 },
          { re: -sys.zeta * sys.wn, im: sys.wn * Math.sqrt(Math.abs(1 - sys.zeta * sys.zeta)) },
          { re: -sys.zeta * sys.wn, im: -sys.wn * Math.sqrt(Math.abs(1 - sys.zeta * sys.zeta)) }
        ];
      }

      document.getElementById('math-char-eq').innerText = eqHTML;

      let stable = true;
      let txt = "";

      roots.forEach(r => {
        if (r.re > 0.001) stable = false;

        const imAbs = Math.abs(r.im);
        const imTxt = imAbs < 0.001 ? "" : `± j${imAbs.toFixed(1)}`;
        txt += `s = ${r.re.toFixed(1)} ${imTxt}<br>`;
      });

      document.getElementById('math-roots').innerHTML = txt;

      const badge = document.getElementById('status-badge');
      badge.innerText = stable ? "Stable" : "Unstable";
      badge.className = "badgeStatus " + (stable ? "stable" : "unstable");

      if (stable !== lastStable) {
        badge.classList.add('bump');
        setTimeout(() => badge.classList.remove('bump'), 180);
        lastStable = stable;
      }

      updateSPlaneChart(roots);
    }

    function solveQuad(a, b, c) {
      if (Math.abs(a) < 1e-5) return [{ re: -c / b, im: 0 }];

      const d = b * b - 4 * a * c;
      if (d >= 0) {
        return [
          { re: (-b + Math.sqrt(d)) / (2 * a), im: 0 },
          { re: (-b - Math.sqrt(d)) / (2 * a), im: 0 }
        ];
      }
      return [
        { re: -b / (2 * a), im: Math.sqrt(-d) / (2 * a) },
        { re: -b / (2 * a), im: -Math.sqrt(-d) / (2 * a) }
      ];
    }

    function solveCubic(a, b, c) {
      const p = b - a * a / 3;
      const q = 2 * a * a * a / 27 - a * b / 3 + c;
      const d = q * q / 4 + p * p * p / 27;

      let roots = [];
      if (d > 0) {
        const u = Math.cbrt(-q / 2 + Math.sqrt(d));
        const v = Math.cbrt(-q / 2 - Math.sqrt(d));
        roots.push({ re: u + v - a / 3, im: 0 });
        roots.push({ re: -(u + v) / 2 - a / 3, im: (u - v) * Math.sqrt(3) / 2 });
        roots.push({ re: -(u + v) / 2 - a / 3, im: -(u - v) * Math.sqrt(3) / 2 });
      } else {
        const k = 2 * Math.sqrt(-p / 3);
        const t = Math.acos(3 * q / (2 * p * k));
        roots.push({ re: k * Math.cos(t / 3) - a / 3, im: 0 });
        roots.push({ re: k * Math.cos((t + 2 * Math.PI) / 3) - a / 3, im: 0 });
        roots.push({ re: k * Math.cos((t + 4 * Math.PI) / 3) - a / 3, im: 0 });
      }
      return roots;
    }

    // =========================
    // Loop (no manual drawing now)
    // =========================
    function loop() {
      updatePhysics();
      requestAnimationFrame(loop);
    }
  </script>
</body>
<script>
// Page transition
window.addEventListener('load', () => {
  document.body.style.opacity = '1';
});
document.addEventListener('click', e => {
  const link = e.target.closest('a');
  if (link && link.href && !link.href.startsWith('javascript') && !link.target) {
    e.preventDefault();
    document.body.style.opacity = '0';
    setTimeout(() => {
      window.location = link.href;
    }, 250);
  }
});
</script>
</html>
